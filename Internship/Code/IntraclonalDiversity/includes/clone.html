<?php $userFile = $_COOKIE['Userfile']; ?>
<br><br>
<h3>Visualization of the repertoire</h3>
<br><br>
<!-- Container of the representation -->
<div style="width: 100%; height: 100%;">
  <!-- Chart1 : contain the zooming circle packing representation -->
  <div style="width: 50%; height: 70%; float: left;" id="chart1"></div>
  <!-- Chart2 : contain the elements needed to observed the clonality threshold -->
  <div id="chart2" style="margin-left: 50%; height: 70%;" >
    <!-- Button that appears when clicking on a specific clone --> 
    <div id="nextButton"><input type="button" onclick="window.location='clonotype.php';" value="Intraclonal study" /></div>
    <!-- Contain the bar chart representation -->
    <div id="barChart" style="width: 100%; height: 37%;"></div>
    <!-- Contain the tree representation -->
    <div id="clonotypeTree" style="width: 100%; height: 37%;"></div>
    <!-- Contain the form which allow to change the value of clonality threshold -->
    <div id="thresholdSelection" style="width: 100%; height: 10%;">
      <form class="thresholdForm" name="thresholdForm">
        <div>
          <div style="float : left;">
            <label class="thresholdLabel" for="threshold">Clonality treshold (%) : </label>
            <input type="text" name="threshold" style="width: 30px;"/>
          </div>
          <input class="enterButton" type="button" name="enterButton" value="Enter" onclick="changeThreshold()" style="width:80px" />
        </div>
      </form>
    </div>
    <!-- Allow the user to select the clones to analyzed -->
    <div id="cloneSelection" style="width: 100%; height: 23%;" ><br>
      <!-- Contain the form which allow to select clone to analyze -->
      <form class="cloneForm" name="cloneForm">
        <div><label>Please select the clones you want to analyze : </label></div><br>
        <div id="checkboxContainer"></div><br>
        <div><label for="email">Enter your e-mail : </label>
        <input type="text" name="email" style="width:250px" /></div><br>
        <center ><input type="button" name="sendButton" value="Send" onclick="chargeClonotypes()" style="width:100px" /></center>
      </form>
    </div>
  </div><br>
  <!-- Chart3 : show correspondance between clone name and abundance -->
  <div id="chart3" style="width: 30%; height: 30%; float: left;" >
    <table id="cloneTable"></table>
  </div>
  <!-- chart4 : show the sequences of V, J and cdr3 regions  -->
  <div id="chart4" style="margin-left: 30%; height: 30%;" >
    <table id="tableSequence" style="height: 80%;"></table>
    <a id="downloadButton" style="float: right; margin-right: 10%; display:none;">
      <button type="button"  onclick="downloadClonesInformations()">Download</button>
    </a>
  </div>
</div>

<script>
/* This script allows the visualization of the repertoire from data supplied by the user. There is thus a number of visualizations in order to represent this repertoire : 
	- zooming circle packing to observe the abundance of clones and clonotypes
	- bar chart to observe the clonality threshold
	- an area allowing to select the clones of interest for further analysis
	- an area where the sequences V, J and cdr3 regions can be observed */

// ************************************************************************************
var yMax = 0;
var threshold = -1;
var firstCreation = true;

function changeThreshold(){ 
  threshold = parseFloat(document.thresholdForm.threshold.value);
  if(threshold){
    var height = (document.getElementById('barChart').offsetHeight/1.25) - 70;
    const y = d3.scaleLinear()
             .range([height, 0]);
    y.domain([0, yMax])

    var svg2 = d3.select("#barChart svg");
    svg2.selectAll(".thresholdLine")
             .attr("y1", y(threshold))
             .attr("y2", y(threshold));
  }else{
    alert("Please enter a percentage");
  }
}

// *********************************** Zooming circle packing visualization of the repertoire ***************************************

//selection of svg
var svg1 = d3.select("#chart1").append("svg")
             .attr("width", "100%")
             .attr("height", "100%"),
    diameter = Math.min(document.getElementById('chart1').offsetWidth, document.getElementById('chart1').offsetHeight),
    g = svg1.append("g").attr("transform", "translate(" + diameter / 2 + "," + diameter / 2 + ")"); /* set the size of the */

//creation of pack layout
var packLayout = d3.pack()
              .size([(diameter), (diameter)])
              .padding(6);//padding around each circle

//declare a new local variable scoped by the DOM
var local = d3.local();

var user = "<?php echo $userFile; ?>",
    file = user +"_repertoire_two_levels_info.json";
    path = "pipeline/usersFiles/"+user+"/"+file;

//loading the json file
d3.json(path, function(error, data) {
  if (error) throw error;

  //separate the data in two: the parents containing the clones and the children containing the clonotypes. This then makes it possible in the representation to keep the proportions between the clones regardless of the number of clonotypes they contain.
  var children = [],
  parent = parseClone(data, children);

  //parent pack to represente the clone
  root = d3.hierarchy(parent)
      .sum(function(d) { return d.value; })
      //.sort(function(a, b) { return b.value - a.value; });

  //store the root in focus variable to allow zoom
  var focus = root, view, cloneZoom = false, child;

  //create the parent circle pack from the parent pack, add a g container for each clone
  var parentNodes = g.selectAll("g")
                 .data(packLayout(root).descendants())
                 .enter().append("g")
      
  //create circle on each g container of the clones and add style to this circle	
  parentNodes.append("circle")
             .attr("r", function(d) { return d.r; })
             .style("opacity", 0.7)
             .style("stroke-width", 2)
             .style("fill", function(d){ return d.data.color; })
             .style("stroke", function(d){ return d.data.stroke; })
             .style("stroke-dasharray", function(d){ return d.data.style; })
             .on("click", function(d,i) { 
                             child = displayClonotype(d,i);
                             cloneZoom=true;
                             if (focus !== d ) { zoom(d), d3.event.stopPropagation();
                               clonePage(children[i-1].children,d.data.name);} 
//data.children[root.children.indexOf(d)].children[0],data.children[root.children.indexOf(d)]["name"]; 
                          });

  //add name of the clone on the circle
  parentNodes.append("text")
             .attr("class", "label")
             .style("fill-opacity", function(d) { return d.parent === root ? 1 : 0; })
             .style("fill", "black")
             .style("font-size", "12px")
             .style("text-anchor", "middle")
             .text(function(d) { if(d.data.value>=1){return d.data.name; } });
//var value = (d.data.value*100)/root.data.value;
//"%" + Math.round(value*100)/100;

  //allow to zoom out
  svg1.on("click", function() { d3.select(child)._groups[0][0].remove(); cloneZoom= false; zoom(root); mainPage(children, firstCreation); } );

  //calculate the cordinates of the circles representing the clones
  nodeProperties([root.x, root.y, root.r * 2], root);

  //display de bar chart graph, the sequences, the selection area and the abundance table
  mainPage(children, firstCreation);
  firstCreation = false;
   
  //separate clones from clonotypes
  function parseClone(data, clonotypes){
    clones = {"value": data["value"], "color": data["color"], "stroke": data["stroke"], "style": data["style"],"children" : []}
    //browse the data and store all the clones the variable "clones" and in the variable "clonotypes"
    for(var i in data.children){
      clones["children"].push({"name": data.children[i]["name"], "length": data.children[i]["length"], "value": data.children[i]["value"], "color": data.children[i]["color"], "stroke": data.children[i]["stroke"], "style": data.children[i]["style"], "idV": data.children[i]["idV"], "idJ": data.children[i]["idJ"], "cdr3": data.children[i]["cdr3"], "productivity": data.children[i]["productivity"]});
      clonotypes.push({"name": data.children[i]["name"], "length": data.children[i]["length"], "value": data.children[i]["value"], "color": data.children[i]["color"], "stroke": data.children[i]["stroke"], "style": data.children[i]["style"], "idV": data.children[i]["idV"], "idJ": data.children[i]["idJ"], "cdr3": data.children[i]["cdr3"], "productivity": data.children[i]["productivity"]});
      //store the clonotypes of the clone in the variable "clonotypes" if there are any
      if(data.children[i].children){
        //clonotype = [];
        //clonotypeOfClone(data.children[i], clonotype); 
        clonotypes[i].children = data.children[i].children;
      }
    }
    return clones;
  }

  //retrieve all the clonotype of a clone in tree format
  /*function clonotypeOfClone(clone, clonotype){
    for(var i in clone.children){
      clonotype.push({"name": clone.children[i]["name"], "length": clone.children[i]["length"], "value": clone.children[i]["value"], "color": clone.children[i]["color"], "stroke": clone.children[i]["stroke"], "style": clone.children[i]["style"]});
      if(clone.children[i].children){clonotypeOfClone(clone.children[i], clonotype)}
    }
  }*/

  //set the size of the nodes
  function nodeProperties(v,child) {
    var k = (diameter / (v[2])); view = v;
    //modify the cordinate of the cercle representing the clones depending on the view
    parentNodes.attr("transform", function(d) { return "translate(" + (d.x - v[0]) * k  + "," + (d.y - v[1]) * k + ")"; });
    parentNodes.selectAll("circle").attr("r", function(d) { return d.r * k; });
//if(d.data.name==clone.data.name){p=[(d.x - v[0])*k,(d.y - v[1])*k,d.r * k];}
    //modify the cordinates of the circle representing the clonotypes if we are zooming in
    if(cloneZoom){
      child.attr("transform", function(d) { return "translate(" + (d.x-(v[2]/2))*k + "," + (d.y-(v[2]/2)) *k + ")"; });
      child.selectAll("circle").attr("r", function(d) { return d.r * k; });
      parentNodes.selectAll("text").style("display","none")
      child.selectAll("text").style("display","inline")
    }else{
    //remove the circle representing the clonotypes of the clones because we are zooming out
      svg1.selectAll(".childNodes").remove();
      parentNodes.selectAll("text").style("display","inline");
    }
  }

  //allow to zoom in or out of the clone in the zooming circle packing reprsentation
  function zoom(d){
    //change the focus variable into the object we are on
    var focus0 = focus; focus = d;
    var transition = d3.transition()
                  .duration(750)	//specify the duration of the transition in miliseconde
                  .tween('zoom', function(d) {			//run custom code during the transition
                                               var transitionFunction = d3.interpolateZoom(view, [focus.x, focus.y, focus.r * 2]);	//apply betwen two views (starts and end)
                                               return function(t) { nodeProperties(transitionFunction(t),child); };
                  });
  }

  function displayClonotype(d,i){
    var focusIndex = i;	//index of the clone we are zooming on
    //store the radius of all the clones
    var parentRadius = packLayout(root).descendants().filter(function(d) { return d.depth == 1; }).map(function(d) { return d.r; });
    //creation of child pack layout
    var childPack = d3.pack().size([parentRadius[i-1]*2 - 2, parentRadius[i-1]*2 - 2])
                 .padding(6);
    //child pack to represente the clonotypes
    var childRoot =  d3.hierarchy(children[i-1])
	         .sum(function(d) { return d.value; });
	         //.sort(function(a,b) { return b.value - a.value; });	
    childRoots = childPack(childRoot).descendants(); 
    //create the child circle pack, add a g container for each clonotype
    var childNodes = parentNodes.filter( function(d,i){ local.set(this, d); return i == focusIndex}) //keep g in the local variable and filter to retrieve the concerned node
                                .selectAll("g")
                                .attr("class","childNodes")
                                .data(childRoots)
                                .enter()
                                .append("g")
                                .attr("transform", function(d) { var offset = local.get(this).r; return "translate(" + (d.x-offset)  + "," + (d.y-offset)  + ")"; })

    //create circle on each g container of the clonotypes and add style to this circle
    childNodes.filter(function(d) { return d.depth > 0 })  //skip parent, it's already drawn
              .append("circle")
              .attr("r", function(d) { return d.r ; })
              .style("opacity", 0.7)
              .style("stroke-width", 2)
              .style("fill", function(d){ return d.data.color; })
              .style("stroke", function(d){ return d.data.stroke; })
              .style("stroke-dasharray", function(d){ return d.data.style; })

    //add name of the clone on the circle
    childNodes.append("text")
              .attr("class", "label")
              .filter(function(d,i) { return i >0; } )	//do not count the root
              .style("fill", "black")
              .style("font-size", "12px")
              .style("text-anchor", "middle")
              .text(function(d) { if(d.data.value>=1){ return d.data.name }});
//var value = (d.data.value*100)/root.data.value;
// "%" + Math.round(value*100)/100;
    return childNodes
  }

})


// **************************************** Show the elements present on the main page **********************************************

  function mainPage(data, state){
    //remove content of barChart when we are zooming out
    document.getElementById("nextButton").style.display = "none";
    //display the bar chart
    var chart = document.getElementById('barChart')
    chart.style.display = "flex";
    //deactivate tree container
    document.getElementById("clonotypeTree").style.display = "none";
    //display the form which allows to enter a threshold value
    var form = document.getElementById('thresholdSelection');
    form.style.display = "block";
    //display the form which allow the user to select clone he want to analyzed
    var cloneSelection = document.getElementById('cloneSelection');
    cloneSelection.style.display = "block";
    //deactivate the abundance table
    var abundanceTable = document.getElementById('cloneTable');
    abundanceTable.innerHTML = "";
    //table correlate the name of the clones and their abundance
    tableAbundance(data);
    //deactivate the table which contain the sequences of the clonotypes and the download button
    var seqTable = document.getElementById('tableSequence');
    seqTable.innerHTML = "";
    //show the sequence of V, J and cdr3 regions of a clone
    tableSequence(data, ["Clone", "V region", "J region", "cdr3", "Productivity"], ["name","idV","idJ","cdr3", "productivity"]);
    var button = document.getElementById('downloadButton');
    button.style.display = "block";
    //create the different element if the user load the page for the first time
    if(state){
      //create bar chart representation
      barChart(data.slice(0,9));
      //create area for the selection of the clone to analyzed
      cloneCheckbox(data);
    }
  }



// **************************************** Bar chart representing abundance of clones **********************************************

  function barChart(data){
    //document.getElementById('barChart').style.height = "80%";
    // set the dimensions and margins of the diagram
    var margin = {top: 20, right: 10, bottom: 50, left: 70},
        width = ((document.getElementById('barChart').offsetWidth)/1.5) - (margin.left + margin.right),	//get width of barChart element in px 
        height = (document.getElementById('barChart').offsetHeight/1.25) - (margin.top + margin.bottom);

    //set the ranges depending on the width and height
    const x = d3.scaleBand()
           .range([0, width])
           .padding(0.1);

    const y = d3.scaleLinear()
           .range([height, 0]);

    //create svg object
    var svg2 = d3.select("#barChart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
        .append("g")
         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    //set the axis range depending on the value
    yMax = (d3.max(data, function(d) { return parseFloat(d["value"]); }));
    x.domain(data.map(function(d) { return d["name"]; }));
    y.domain([0, yMax]);

    //add the x axis to the svg
    svg2.append("g")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x).tickSize(0))
        .selectAll("text")	
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-65)");
    
    //add the y axis to the svg
    svg2.append("g")
        .call(d3.axisLeft(y).ticks(6));
        //.text("Abundance");

    //add the bar corresponding to the abundance of the clones. The width of the bar is determined by the function x and the height by the y function
    svg2.selectAll(".bar")
        .data(data)
        .enter().append("rect")
        .style("fill", function(d){ return d.color; })
        .attr("x", d => x(d["name"]))
        .attr("width", x.bandwidth())
        .attr("y", d => y(d["value"]))
        .attr("height", d => height - y(d["value"]));

    //text label for the y axis
    svg2.append("text")
        .attr("transform", "rotate(-90)")
        .attr("y", 0 - margin.left)
        .attr("x",0 - (height / 2))
        .attr("dy", "1em")
        .style("text-anchor", "middle")
        .style("font", "0.8em 'Trebuchet MS'")
        .text("Abundance (%)");   

     //the user doesn't enter a threshold value
     if(threshold==-1){threshold=yMax;}
     // Draw the line for the threshold
     svg2.append("line")
         .attr("class","thresholdLine")
           .attr("x1", 0)
           .attr("y1", y(threshold))
           .attr("x2", width)
           .attr("y2", y(threshold));
  }



// **************************************** Area for the selection of clone to analyzed **********************************************

  function cloneCheckbox(data){
    //select the div element which will contain the checkbox
    var container = document.getElementById('checkboxContainer');
    //browse the clones and create a checkbox for each of them
    for(var i in data){
      var cloneName = data[i]["name"];	 //recover the name of the clone
      //show only clones with at least 4 clonotypes
      if(data[i]["children"] && data[i]["children"].length>=4){
        //create a checkbox element
        var checkbox = document.createElement('input');
        checkbox.type = "checkbox";
        checkbox.name = cloneName;
        checkbox.value = cloneName;
        checkbox.id = cloneName;
        //create a label element
        var label = document.createElement('label');
        label.htmlFor = cloneName;
        label.appendChild(document.createTextNode(cloneName));
        //create a line break element
        var br=document.createElement("br");
        //add all the elemnt created to the div container
        container.appendChild(checkbox);
        container.appendChild(label);
        container.appendChild(br);
      }
    }
  }



// ************************************ Table of the name of the clones and their abundance ******************************************

  function tableAbundance(data){

    //select the table element
    var table = document.getElementById('cloneTable');

    //create a thead element and add it to the table
    var thead = document.createElement('thead');
    table.appendChild(thead);

    //create a tr element to add a line
    var tr = document.createElement('tr');
    
    //create a th element that contain the name of the first column
    var th1 = document.createElement('th');
    th1.appendChild(document.createTextNode("Name"));
    //create a th element that contain the name of the second column
    var th2 = document.createElement('th');
    th2.appendChild(document.createTextNode("Abundance(%)"));

    //add all the element created to the table
    thead.appendChild(tr);
    tr.appendChild(th1);
    tr.appendChild(th2);

    //create a tbody element and add it to the table
    var tbody = document.createElement('tbody');
    table.appendChild(tbody);

    //browse the clones and create a line in the table for each of them
    for(var i in data){

      //create a tr element to add a line
      var tr = document.createElement('tr');

      //create a first td element to add a cell which will contain the name of the clone
      var td1 = document.createElement('td');
      td1.appendChild(document.createTextNode(data[i]["name"]));
      //create a second td element to add a cell which will contain the abundance of the clone
      var td2 = document.createElement('td');
      td2.appendChild(document.createTextNode(data[i]["value"]));

      //add all the element created to the table
      tbody.appendChild(tr);
      tr.appendChild(td1);
      tr.appendChild(td2);

    }

  }



// ****************************************** Sequences of the V, j and cdr3 regions *************************************************

  function tableSequence(data, heading, value){

    //select the div element which will contain the sequences
    var table = document.getElementById('tableSequence');
    //create a thead element and add it to the table
    var thead = document.createElement('thead');
    table.appendChild(thead);
    //create a tr element and add it to the table
    var tr = document.createElement('tr');
    thead.appendChild(tr);

    for(var i in heading){

      //create the title of the column 
      var th = document.createElement('th');
      th.appendChild(document.createTextNode(heading[i]));

      //add the title to the table
      tr.appendChild(th);
    
    }

    //create a tbody element and add it to the table
    var tbody = document.createElement('tbody');
    table.appendChild(tbody);

    //browse the clones and show the sequences for each of them
    for(var i in data){ 

      //create a tr element to add a line and add it to the table
      var tr = document.createElement('tr');
      tbody.appendChild(tr);

      for(var j in value){

        //create a td element to add a cell
        var td = document.createElement('td');
        //create a p element which will contain the data of the clone or clonotype
        var p = document.createElement('p');
        p.classList = "tableSeqCell";
        p.appendChild(document.createTextNode(data[i][value[j]]));
        //add it to the td element
        td.appendChild(p);

         //add all the element created to the table      
         tr.appendChild(td);
    
      }
    }
  }


// ************************************** Load the page showing the description of a clone *******************************************

  function clonePage(data, clone){
    //remove the elements of the main page
    //deactivate the bar chart elements
    var threshold = document.getElementById('thresholdSelection');
    threshold.style.display = "none";
    var chart = document.getElementById('barChart');
    chart.style.display = "none";
    //deactivate the area for the clone selection
    var selectionClone = document.getElementById('cloneSelection');
    selectionClone.style.display = "none";
    //deactivate the abundance table
    var abundanceTable = document.getElementById('cloneTable');
    abundanceTable.innerHTML = "";
    //table correlate the name of the clonotypes and their abundance
    tableAbundance(data);
    //deactivate the table which contain the sequences of the clones and the download button
    var seqTable = document.getElementById('tableSequence');
    seqTable.innerHTML = "";
    //show name, cdr3, productivity and sequence of the clonotypes in a table
    tableSequence(data, ["Name", "cdr3", "Productivity", "Sequence"], ["name", "cdr3", "productivity", "seq"])
    var button = document.getElementById('downloadButton');
    button.style.display = "none";
    //activate button to access to the description of clones
    document.getElementById("nextButton").style.display = "block";
    //launch the tool to obtained hierarchy of clonotypes
    //activate tree container
    document.getElementById("clonotypeTree").style.display = "block";
    d3.select("#clonotypeTree svg").remove()
    //represent these data in the form of a tree 
    displayTree(clone) 
  }


// ******************************* Allows the user to download all the information of the repertoire ********************************

  function downloadClonesInformations(clone){
    var link = document.getElementById('downloadButton');
    link.href="pipeline/usersFiles/example/repertoire_data.csv";
  }

// ******************************* Display of clonotype tree for a given clone ****************************************************

function displayTree(clone){
  //localStorage.removeItem( 'clonotypeData' ); // Clear the localStorage
  localStorage.setItem( 'clone', clone );

  //CAUTOUS : call the tool for analyse the intraclonal heterogeneity

  //loading the json file
  d3.json("pipeline/usersFiles/example/example_"+clone+"_clonotype.json", function(error, dataTree) {
    if (error) throw error;

    var data = d3.hierarchy(dataTree); //data structure that represente a hieratchy

    //change the depth of the node to allow to represent the different length of the branch
    changeDepth(data);
    //save the data needed to the tree to pass them on the next page
    
    //set the dimensions and margins of the diagram
    var margin = {top: 20, right: 10, bottom: 20, left: 10},
    width = (document.getElementById('chart2').offsetWidth) - margin.left - margin.right,
    height = (document.getElementById('chart2').offsetHeight) - margin.top - margin.bottom;

    //add an svg object to the chart2 element
    var svg2 = d3.select("#clonotypeTree").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
          .append("g")
           .attr("transform", "translate(" + width/2 +','+ height/2 + ")");

    // declares a tree layout and assigns the size
    var tree = d3.tree()	//creating the tree layout 
            .size([2 * Math.PI, height/2])
            .separation(function(a, b) { return ((a.depth >= 2) && (b.depth >= 2)) ? 1 : 4; });
    
    //parameters use to collapse the tree       
    var duration = 750;
    data.x0 = height / 2;
    data.y0 = 0;

    updateTree(data);

    function updateTree(source){

      //assign properties to the data (coordinates, depth, ...)
      var root = tree(data);

        //adjust the length of the branch depending on the radius of the node and the position between the nodes
        //branchLength(root);

        // ********* Creation of the nodes *********

        //add each node as a group
        var node = svg2.selectAll("g")
                .data(root.descendants());

        var nodeEnter = node.enter().append("g")
                     .attr("transform", function(d) { return "translate(" + radialPoint(source.x0, source.y0) + ")";})	//position the nodes
                     .on('dblclick', changeChildren);

        // adds the circle to the node
        nodeEnter.append("circle")
                 .style("fill", function(d){ return d.data.color; })
        .style("stroke", function(d){ return d.data.stroke; })
        .style("stroke-dasharray", function(d){ return d.data.style; })
        .style("stroke-width", 1.5)
                 .attr("r", function(d) { return d.data.value? 2*d.data.value : 0}); //set the diameter of the node

        //add text to the node
        nodeEnter.append("text")
                 .attr('font-size', 12) //set the size of the text
                 .attr("dy", function(d) { return 15+(2*d.data.value)})	//set the emplacement of the text
                 .attr("dx", 15)
                 .attr("text-anchor", "middle")
                 .text(function(d) { if(d.data.name!="naive"){ return d.data.name; }})
                 .clone(true).lower()
                 .attr("stroke", "white");


        var nodeUpdate = nodeEnter.merge(node);

        //transition to the proper position for the node
        nodeUpdate.transition()
                  .duration(duration)
                  .attr("transform", function(d) { return "translate(" + radialPoint(d.x, d.y) + ")";});

        nodeUpdate.select('circle')
                  .attr('r', function(d) { return d.data.value? 2*d.data.value : 0})
                  .attr('cursor', 'pointer');

        //remove any exiting nodes
        var nodeExit = node.exit().transition()
                    .duration(duration)
                    .attr("transform", function(d) { return "translate(" + radialPoint(source.x, source.y) + ")";})
                    .remove();

        // ********* Creation of links *********

        //add the links between the nodes
        var link = svg2.selectAll("path")
                .data(root.descendants().slice(1));
              
        var linkEnter = link.enter().insert('path',"g")	//SVG path allow to draw shape
              .attr("fill", "none")
              .attr("stroke", "#555")
              .attr("stroke-opacity", 0.5)
              .attr("stroke-width", 2)
                     .attr("d", function(d){ var s = {x : source.x0, y : source.y0}; return branchShape(s, s);});

        //update link
        var linkUpdate = linkEnter.merge(link);

        //transition back to the parent element position
        linkUpdate.transition()
                  .duration(duration)
                  .attr("d", function(d){ return branchShape(d, d.parent); });

        //remove any exiting links
        var linkExit = link.exit().transition()
                    .duration(duration)
                    .attr("d", function(d){ var s = {x : source.x, y : source.y}; return branchShape(s, s);})
                    .remove();

        root.descendants().forEach(function(d){ d.x0 = d.x; d.y0 = d.y;});

      }

      function changeChildren(d){
        if(d.children){
          d._children = d.children;
          d.children = null;
        }else{
          d.children = d._children;
          d._children = null;
        }
        updateTree(d);
      }


    function collapse(d){
      if(d.children){
        if(d.depth==5){
          d._children = d.children;
          d._children.forEach(collapse);
          d.children = null;
        }else{
          d.children.forEach(collapse);
        }
      }
    }

  });


  function radialPoint(x, y) {
	return [(y = +y) * Math.cos(x -= Math.PI / 2), y * Math.sin(x)];
  }

//give the start and end point to a branch    
    function branchShape(s,t) {
      return "M" + radialPoint(s.x, s.y)[0] + "," + radialPoint(s.x, s.y)[1] + " " + radialPoint(t.x, t.y)[0] + "," + radialPoint(t.x, t.y)[1]; //M means move to
    }
}

function changeDepth(d){
  for(var i in d.children){ 
    d.children[i].depth = d.depth+(1*d.children[i].data["length"]);
    if (d.children[i].children){changeDepth(d.children[i]);}
  }
}
    
    function branchLength(nodes){
      //var maxValue = maxClonotypeValue(nodes);
      for(var i in nodes.children){
        coef = (nodes.children[i].x-nodes.x)/(nodes.children[i].y-nodes.y);
        nodes.children[i].y = nodes.children[i].y + ((nodes.y - nodes.children[i].y) * (1-nodes.children[i].data["length"]));   
        nodes.children[i].x = (nodes.children[i].y * coef) + nodes.x;
        if(nodes.children[i].children != undefined){
          branchLength(nodes.children[i]);
        }
      }
    }

  //browse the tree to find the clonotype with the biggest abundance and return its value
  function maxClonotypeValue(data, maxValue){
    for(var i in data.children){
      if(data.children[i].data.value > maxValue){maxValue = data.children[i].data.value;} //change the maxValue
      if(data.children[i].children != undefined){maxClonotypeValue(data.children[i], maxValue);}
    }
    return maxValue
  }

  //tranform the data format to obtained circle representation
  function parseClone(data){
    cloneInformation = {"color": data["color"], "stroke": data["stroke"], "style": data["style"], "children" : []}
    for(var i in data.children){
      cloneInformation["children"].push({"name": data.children[i]["name"], "length": data.children[i]["length"], "value": data.children[i]["value"], "color": data.children[i]["color"], "stroke": data.children[i]["stroke"], "style": data.children[i]["style"]});
      if(data.children[i].children){
        clonotype = [];
        clonotypeOfClone(data.children[i], clonotype);
        cloneInformation.children[i].children = clonotype;
      }
    }
    return cloneInformation;
  }

  //retrieve all the clonotype of a clone
  function clonotypeOfClone(clone, clonotype){
    for(var i in clone.children){
      clonotype.push({"name": clone.children[i]["name"], "length": clone.children[i]["length"], "value": clone.children[i]["value"], "color": clone.children[i]["color"], "stroke": clone.children[i]["stroke"], "style": clone.children[i]["style"]});
      if(clone.children[i].children){clonotypeOfClone(clone.children[i], clonotype)}
    }
  }

</script>

